<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸˆ CAT [view]</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸˆ</text></svg>">
<link id="google-font" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Roboto+Mono:wght@400;500&family=BIZ+UDGothic:wght@400;700&family=Zen+Kaku+Gothic+New:wght@400;500;700&display=swap" rel="stylesheet">
<style>

/* ============================================================
   CSSå¤‰æ•°ï¼šãƒ†ãƒ¼ãƒå®šç¾©
   ============================================================ */

/* ã‚¢ã‚¯ã‚»ã‚·ãƒ–ãƒ«ãƒ†ãƒ¼ãƒ(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ) */
:root, [data-theme="accessible"] {
  --bg: #1a1a2e;
  --surface: #242440;
  --surface2: #2e2e50;
  --border: #4a4a70;
  --accent: #f0d060;
  --accent2: #ffe080;
  --text: #f0ece0;
  --text-dim: #b0aec0;
  --text-bright: #ffffff;
  --green: #60e0a0;
  --blue: #80c8ff;
  --r1-color: #60d080;
  --r2-color: #f0d060;
  --r3-color: #ff9060;
  --highlight: rgba(240,208,96,0.15);
  --highlight-border: rgba(240,208,96,0.6);
  --shadow: rgba(0,0,0,0.5);
}

/* ã‚²ãƒ¼ãƒ ãƒ†ãƒ¼ãƒ */
[data-theme="game"] {
  --bg: #0a0e14;
  --surface: #111820;
  --surface2: #1a2330;
  --border: #1e3048;
  --accent: #c8a84b;
  --accent2: #e8c96a;
  --text: #d4c9b0;
  --text-dim: #7a8a9a;
  --text-bright: #f0e6cc;
  --green: #4caf82;
  --blue: #4a9ade;
  --r1-color: #7abf7a;
  --r2-color: #c8a84b;
  --r3-color: #e08060;
  --highlight: rgba(200,168,75,0.12);
  --highlight-border: rgba(200,168,75,0.5);
  --shadow: rgba(0,0,0,0.7);
}

/* ============================================================
   ãƒ•ã‚©ãƒ³ãƒˆå®šç¾©
   ============================================================ */
[data-font="noto"] { --font-main: 'Noto Sans JP', sans-serif; }
[data-font="biz"]  { --font-main: 'BIZ UDGothic', sans-serif; }
[data-font="zen"]  { --font-main: 'Zen Kaku Gothic New', sans-serif; }

/* ============================================================
   æ–‡å­—ã‚µã‚¤ã‚ºå®šç¾©
   ============================================================ */
[data-size="s"] { --sz-base: 12px; --sz-sm: 10px; --sz-lg: 14px; --sz-xl: 20px; --sz-xxl: 28px; }
[data-size="m"] { --sz-base: 15px; --sz-sm: 12px; --sz-lg: 17px; --sz-xl: 24px; --sz-xxl: 34px; }
[data-size="l"] { --sz-base: 18px; --sz-sm: 15px; --sz-lg: 21px; --sz-xl: 28px; --sz-xxl: 40px; }

/* ============================================================
   ãƒªã‚»ãƒƒãƒˆãƒ»ãƒ™ãƒ¼ã‚¹
   ============================================================ */
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: var(--font-main, 'Noto Sans JP', sans-serif);
  font-size: var(--sz-base, 15px);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  transition: background 0.3s, color 0.3s;
}

/* ============================================================
   ãƒ˜ãƒƒãƒ€ãƒ¼
   ============================================================ */
.header {
  background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, transparent 100%);
  border-bottom: 1px solid var(--border);
  padding: 10px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 200;
  backdrop-filter: blur(12px);
  gap: 8px;
}

.header-left { display: flex; align-items: center; gap: 10px; }

.header-title {
  font-size: var(--sz-sm);
  font-weight: 700;
  color: var(--accent);
  letter-spacing: 0.12em;
  text-transform: uppercase;
  white-space: nowrap;
}

.header-right { display: flex; align-items: center; gap: 10px; }

.clock {
  font-family: 'Roboto Mono', monospace;
  font-size: var(--sz-xl);
  color: var(--text-bright);
  letter-spacing: 0.05em;
  line-height: 1;
}

.clock-date {
  font-size: var(--sz-sm);
  color: var(--text-dim);
  text-align: right;
  margin-top: 2px;
}

/* ç¾åœ¨ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
.btn-now {
  background: var(--accent);
  color: var(--bg);
  border: none;
  border-radius: 5px;
  padding: 6px 14px;
  font-family: var(--font-main);
  font-size: var(--sz-sm);
  font-weight: 700;
  cursor: pointer;
  white-space: nowrap;
  transition: opacity 0.2s;
}
.btn-now:hover { opacity: 0.85; }

/* è¨­å®šãƒœã‚¿ãƒ³ */
.btn-settings {
  background: var(--surface2);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 5px;
  padding: 6px 12px;
  font-family: var(--font-main);
  font-size: var(--sz-sm);
  cursor: pointer;
  white-space: nowrap;
  transition: border-color 0.2s;
}
.btn-settings:hover { border-color: var(--accent); color: var(--accent); }

/* ============================================================
   è¨­å®šãƒ‘ãƒãƒ«
   ============================================================ */
.settings-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 300;
  align-items: flex-start;
  justify-content: flex-end;
}
.settings-overlay.open { display: flex; }

.settings-panel {
  background: var(--surface);
  border-left: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
  width: 280px;
  padding: 20px;
  margin-top: 52px;
  border-radius: 0 0 0 10px;
  box-shadow: -4px 4px 20px var(--shadow);
}

.settings-title {
  font-size: var(--sz-lg);
  font-weight: 700;
  color: var(--text-bright);
  margin-bottom: 16px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border);
}

.settings-group { margin-bottom: 18px; }

.settings-group-label {
  font-size: var(--sz-sm);
  color: var(--text-dim);
  letter-spacing: 0.1em;
  margin-bottom: 8px;
}

.settings-options { display: flex; gap: 6px; flex-wrap: wrap; }

.opt-btn {
  background: var(--surface2);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 5px;
  padding: 6px 14px;
  font-family: var(--font-main);
  font-size: var(--sz-sm);
  cursor: pointer;
  transition: all 0.15s;
}
.opt-btn:hover { border-color: var(--accent); }
.opt-btn.active {
  background: var(--accent);
  color: var(--bg);
  border-color: var(--accent);
  font-weight: 700;
}

.settings-close {
  width: 100%;
  margin-top: 6px;
  background: transparent;
  color: var(--text-dim);
  border: 1px solid var(--border);
  border-radius: 5px;
  padding: 8px;
  font-family: var(--font-main);
  font-size: var(--sz-sm);
  cursor: pointer;
}
.settings-close:hover { color: var(--text); border-color: var(--text-dim); }

/* ============================================================
   ãƒªãƒ¯ãƒ¼ãƒ‰ãƒãƒ¼
   ============================================================ */
.reward-bar {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 8px 16px;
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.reward-bar-label {
  font-size: var(--sz-sm);
  color: var(--text-dim);
  margin-right: 2px;
}

.reward-badge {
  display: flex;
  align-items: center;
  gap: 6px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 4px 12px;
  font-size: var(--sz-sm);
}
.reward-badge .r-num {
  font-family: 'Roboto Mono', monospace;
  font-size: var(--sz-base);
  font-weight: bold;
}
.reward-badge.r1 { border-color: var(--r1-color); }
.reward-badge.r1 .r-num { color: var(--r1-color); }
.reward-badge.r2 { border-color: var(--r2-color); }
.reward-badge.r2 .r-num { color: var(--r2-color); }
.reward-badge.r3 { border-color: var(--r3-color); }
.reward-badge.r3 .r-num { color: var(--r3-color); }

.reward-bar-note {
  font-size: var(--sz-sm);
  color: var(--text-dim);
}

/* ============================================================
   ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
   ============================================================ */
.main {
  display: grid;
  grid-template-columns: 1fr 320px;
  height: calc(100vh - 90px);
}

/* ============================================================
   å·¦ãƒ‘ãƒãƒ«ï¼šç¾åœ¨ã®CAè©³ç´°
   ============================================================ */
.current-panel {
  padding: 20px;
  overflow-y: auto;
  border-right: 1px solid var(--border);
}

.current-slot-label {
  font-size: var(--sz-sm);
  color: var(--text-dim);
  letter-spacing: 0.1em;
  margin-bottom: 4px;
}

.current-event-name {
  font-size: var(--sz-xxl);
  font-weight: 700;
  color: var(--text-bright);
  margin-bottom: 10px;
  line-height: 1.2;
}

.current-time-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.time-chip {
  font-family: 'Roboto Mono', monospace;
  font-size: var(--sz-base);
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 3px 10px;
  color: var(--accent);
}

/* ãƒªãƒ¯ãƒ¼ãƒ‰å¿…è¦ãƒã‚¤ãƒ³ãƒˆ */
.reward-req {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
}

.reward-req-item {
  flex: 1;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 10px 12px;
  text-align: center;
}
.reward-req-item.r1 { border-top: 3px solid var(--r1-color); }
.reward-req-item.r2 { border-top: 3px solid var(--r2-color); }
.reward-req-item.r3 { border-top: 3px solid var(--r3-color); }

.reward-req-label {
  font-size: var(--sz-sm);
  color: var(--text-dim);
  margin-bottom: 4px;
}

.reward-req-pts {
  font-family: 'Roboto Mono', monospace;
  font-size: var(--sz-lg);
  font-weight: bold;
}
.r1 .reward-req-pts { color: var(--r1-color); }
.r2 .reward-req-pts { color: var(--r2-color); }
.r3 .reward-req-pts { color: var(--r3-color); }

/* ãƒãƒ¼ãƒˆ */
.slot-note {
  font-size: var(--sz-sm);
  color: var(--blue);
  background: rgba(128,200,255,0.08);
  border: 1px solid rgba(128,200,255,0.25);
  border-radius: 5px;
  padding: 8px 12px;
  margin-bottom: 16px;
}

/* ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ */
.tasks-title {
  font-size: var(--sz-sm);
  color: var(--text-dim);
  letter-spacing: 0.1em;
  margin-bottom: 8px;
  padding-bottom: 6px;
  border-bottom: 1px solid var(--border);
}

.task-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 12px;
  border-radius: 5px;
  margin-bottom: 4px;
  background: var(--surface);
  border: 1px solid transparent;
  transition: border-color 0.2s;
}
.task-item:hover { border-color: var(--border); }

.task-name {
  font-size: var(--sz-base);
  color: var(--text);
  flex: 1;
  padding-right: 12px;
  line-height: 1.4;
}

.task-pts {
  font-family: 'Roboto Mono', monospace;
  font-size: var(--sz-base);
  color: var(--green);
  white-space: nowrap;
  font-weight: bold;
}
.task-pts.high { color: var(--accent2); }
.task-pts.very-high { color: var(--r3-color); }

.viewing-badge {
  display: inline-block;
  font-size: var(--sz-sm);
  background: rgba(128,200,255,0.15);
  border: 1px solid rgba(128,200,255,0.3);
  color: var(--blue);
  border-radius: 3px;
  padding: 1px 8px;
  margin-left: 8px;
  vertical-align: middle;
}

/* ============================================================
   å³ãƒ‘ãƒãƒ«ï¼šé€±é–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
   ============================================================ */
.schedule-panel {
  overflow-y: auto;
  background: var(--surface);
}

.schedule-header {
  padding: 10px 14px 6px;
  font-size: var(--sz-sm);
  color: var(--text-dim);
  letter-spacing: 0.1em;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  background: var(--surface);
  z-index: 10;
}

.day-jump {
  display: flex;
  gap: 4px;
  padding: 6px 14px 8px;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 33px;
  background: var(--surface);
  z-index: 10;
}

.day-jump-btn {
  flex: 1;
  min-width: 36px;
  min-height: 36px;
  background: var(--surface2);
  color: var(--text-dim);
  border: 1px solid var(--border);
  border-radius: 5px;
  font-family: var(--font-main);
  font-size: var(--sz-sm);
  font-weight: 700;
  cursor: pointer;
  transition: all 0.15s;
  display: flex;
  align-items: center;
  justify-content: center;
}
.day-jump-btn:hover { border-color: var(--accent); color: var(--accent); }
.day-jump-btn.today { background: var(--accent); color: var(--bg); border-color: var(--accent); }

.day-section { border-bottom: 1px solid var(--border); }

.day-label {
  padding: 7px 14px;
  font-size: var(--sz-sm);
  font-weight: 700;
  color: var(--accent);
  letter-spacing: 0.12em;
  background: rgba(255,255,255,0.03);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 83px;
  z-index: 9;
}

.slot-row {
  display: flex;
  align-items: center;
  padding: 9px 14px;
  border-bottom: 1px solid rgba(100,100,150,0.2);
  cursor: pointer;
  transition: background 0.15s;
  gap: 10px;
}
.slot-row:hover { background: rgba(255,255,255,0.04); }
.slot-row.active {
  background: var(--highlight);
  border-left: 3px solid var(--accent);
  padding-left: 11px;
}

.slot-times {
  font-family: 'Roboto Mono', monospace;
  font-size: var(--sz-sm);
  color: var(--text-dim);
  min-width: 68px;
  line-height: 1.7;
}
.slot-row.active .slot-times { color: var(--accent); }

.slot-event {
  font-size: var(--sz-base);
  color: var(--text);
  flex: 1;
}
.slot-row.active .slot-event { color: var(--text-bright); font-weight: 700; }

.slot-r3 {
  font-family: 'Roboto Mono', monospace;
  font-size: var(--sz-sm);
  color: var(--text-dim);
  white-space: nowrap;
}

/* ============================================================
   ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼
   ============================================================ */
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* ============================================================
   ã‚¹ãƒãƒ›ç”¨ï¼šã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
   ============================================================ */
@media (max-width: 768px) {

  /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
  .header {
    padding: 8px 12px;
    flex-wrap: wrap;
  }
  .header-title {
    font-size: 10px;
  }
  .clock {
    font-size: var(--sz-lg);
  }
  .clock-date {
    font-size: 10px;
  }
  .btn-now {
    padding: 5px 10px;
    font-size: 11px;
  }
  .btn-settings {
    padding: 5px 10px;
    font-size: 11px;
  }

  /* ãƒªãƒ¯ãƒ¼ãƒ‰ãƒãƒ¼ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
  .reward-bar {
    padding: 6px 12px;
    gap: 5px;
  }
  .reward-bar-label { display: none; }
  .reward-badge {
    padding: 3px 8px;
    font-size: 11px;
  }
  .reward-bar-note { display: none; }

  /* ã‚¿ãƒ–UI */
  .mobile-tabs {
    display: flex;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
  }
  .mobile-tab {
    flex: 1;
    padding: 10px;
    text-align: center;
    font-family: var(--font-main);
    font-size: var(--sz-sm);
    font-weight: 700;
    color: var(--text-dim);
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    transition: all 0.15s;
  }
  .mobile-tab.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
  }

  /* ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ç¸¦1ã‚«ãƒ©ãƒ ã« */
  .main {
    display: block;
    height: calc(100vh - 130px);
  }

  .current-panel {
    height: 100%;
    border-right: none;
  }

  .schedule-panel {
    height: 100%;
  }

  /* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã§è¡¨ç¤º/éè¡¨ç¤º */
  .main.show-schedule .current-panel { display: none; }
  .main.show-current .schedule-panel { display: none; }
}

/* PCã§ã¯ã‚¿ãƒ–ã‚’éè¡¨ç¤º */
@media (min-width: 769px) {
  .mobile-tabs { display: none; }
}

</style>
</head>
<body data-theme="accessible" data-size="m" data-font="noto">

<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<div class="header">
  <div class="header-left">
    <div class="header-title">ğŸˆ Colony Action Tool [view]</div>
    <button class="btn-now" onclick="goToNow()">â–¶ ç¾åœ¨ã«æˆ»ã‚‹</button>
  </div>
  <div class="header-right">
    <div>
      <div class="clock" id="clock">--:--:--</div>
      <div class="clock-date" id="clock-date">---</div>
    </div>
    <button class="btn-settings" onclick="toggleSettings()">âš™ è¨­å®š</button>
  </div>
</div>

<!-- è¨­å®šãƒ‘ãƒãƒ« -->
<div class="settings-overlay" id="settings-overlay" onclick="closeSettingsOnOverlay(event)">
  <div class="settings-panel">
    <div class="settings-title">âš™ è¡¨ç¤ºè¨­å®š</div>

    <div class="settings-group">
      <div class="settings-group-label">ãƒ†ãƒ¼ãƒ</div>
      <div class="settings-options">
        <button class="opt-btn" data-setting="theme" data-value="accessible" onclick="applySetting('theme','accessible',this)">ğŸ‘ è¦‹ã‚„ã™ã„</button>
        <button class="opt-btn" data-setting="theme" data-value="game" onclick="applySetting('theme','game',this)">ğŸ¨ ã‚²ãƒ¼ãƒ é¢¨</button>
      </div>
    </div>

    <div class="settings-group">
      <div class="settings-group-label">æ–‡å­—ã‚µã‚¤ã‚º</div>
      <div class="settings-options">
        <button class="opt-btn" data-setting="size" data-value="s" onclick="applySetting('size','s',this)">å°</button>
        <button class="opt-btn" data-setting="size" data-value="m" onclick="applySetting('size','m',this)">ä¸­</button>
        <button class="opt-btn" data-setting="size" data-value="l" onclick="applySetting('size','l',this)">å¤§</button>
      </div>
    </div>

    <div class="settings-group">
      <div class="settings-group-label">ãƒ•ã‚©ãƒ³ãƒˆ</div>
      <div class="settings-options">
        <button class="opt-btn" data-setting="font" data-value="noto" onclick="applySetting('font','noto',this)" style="font-family:'Noto Sans JP'">Noto</button>
        <button class="opt-btn" data-setting="font" data-value="biz" onclick="applySetting('font','biz',this)" style="font-family:'BIZ UDGothic'">BIZ UD</button>
        <button class="opt-btn" data-setting="font" data-value="zen" onclick="applySetting('font','zen',this)" style="font-family:'Zen Kaku Gothic New'">ZEN</button>
      </div>
    </div>

    <button class="settings-close" onclick="toggleSettings()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- ãƒªãƒ¯ãƒ¼ãƒ‰ãƒãƒ¼ -->
<div class="reward-bar">
  <span class="reward-bar-label">å¥³ç‹Lv25 ãƒªãƒ¯ãƒ¼ãƒ‰é–¾å€¤</span>
  <div class="reward-badge r1"><span>ãƒªãƒ¯ãƒ¼ãƒ‰1</span><span class="r-num" id="rb1">-</span></div>
  <div class="reward-badge r2"><span>ãƒªãƒ¯ãƒ¼ãƒ‰2</span><span class="r-num" id="rb2">-</span></div>
  <div class="reward-badge r3"><span>ãƒªãƒ¯ãƒ¼ãƒ‰3</span><span class="r-num" id="rb3">-</span></div>
  <span class="reward-bar-note" id="reward-bar-note"></span>
</div>

<!-- ãƒ¢ãƒã‚¤ãƒ«ã‚¿ãƒ–(ã‚¹ãƒãƒ›ã®ã¿è¡¨ç¤º) -->
<div class="mobile-tabs" id="mobile-tabs">
  <button class="mobile-tab active" id="tab-current" onclick="switchTab('current')">ç¾åœ¨ã®ã‚¹ãƒ­ãƒƒãƒˆ</button>
  <button class="mobile-tab" id="tab-schedule" onclick="switchTab('schedule')">é€±é–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« ğŸˆ</button>
</div>

<!-- ãƒ¡ã‚¤ãƒ³ -->
<div class="main show-current" id="main-content">
  <div class="current-panel" id="current-panel">
    <div style="color:var(--text-dim);padding:20px;">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>
  <div class="schedule-panel" id="schedule-panel"></div>
</div>

<script>
function jumpToDay(dayKey) {
  const el = document.getElementById('day-' + dayKey);
  if (el) el.scrollIntoView({ block: 'start', behavior: 'smooth' });
}

// ============================================================
// ãƒ¢ãƒã‚¤ãƒ«ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
// ============================================================
function switchTab(tab) {
  const main = document.querySelector('.main');
  const tabCurrent = document.getElementById('tab-current');
  const tabSchedule = document.getElementById('tab-schedule');
  if (tab === 'current') {
    main.classList.remove('show-schedule');
    main.classList.add('show-current');
    tabCurrent.classList.add('active');
    tabSchedule.classList.remove('active');
  } else {
    main.classList.remove('show-current');
    main.classList.add('show-schedule');
    tabSchedule.classList.add('active');
    tabCurrent.classList.remove('active');
  }
}

// ============================================================
// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹èª­ã¿è¾¼ã¿(GitHub Pagesé‹ç”¨æ™‚ã¯å¤–éƒ¨JSONã‚’å‚ç…§)
// ============================================================
const DB_URL = 'ca_database.json';
let DB = null;

async function loadDB() {
  try {
    const res = await fetch(DB_URL);
    DB = await res.json();
  } catch(e) {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚¤ãƒ³ãƒ©ã‚¤ãƒ³æœ€å°ãƒ‡ãƒ¼ã‚¿(èª­ã¿è¾¼ã¿å¤±æ•—æ™‚)
    console.error('DBèª­ã¿è¾¼ã¿å¤±æ•—:', e);
    document.getElementById('current-panel').innerHTML =
      '<div style="color:var(--r3-color);padding:20px;">âš  ca_database.json ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã« ca_database.json ãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>';
    return false;
  }
  return true;
}

// ============================================================
// è¨­å®šç®¡ç†
// ============================================================
const SETTINGS_KEY = 'ca_tool_settings';
const DEFAULTS = { theme: 'accessible', size: 'm', font: 'noto' };

function loadSettings() {
  try {
    const saved = localStorage.getItem(SETTINGS_KEY);
    return saved ? { ...DEFAULTS, ...JSON.parse(saved) } : { ...DEFAULTS };
  } catch(e) { return { ...DEFAULTS }; }
}

function saveSettings(settings) {
  try { localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); } catch(e) {}
}

function applySettingsToDOM(settings) {
  document.body.dataset.theme = settings.theme;
  document.body.dataset.size  = settings.size;
  document.body.dataset.font  = settings.font;
}

function applySetting(key, value, btn) {
  const settings = loadSettings();
  settings[key] = value;
  saveSettings(settings);
  applySettingsToDOM(settings);
  // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
  document.querySelectorAll(`.opt-btn[data-setting="${key}"]`).forEach(b => {
    b.classList.toggle('active', b.dataset.value === value);
  });
}

function syncSettingButtons(settings) {
  ['theme','size','font'].forEach(key => {
    document.querySelectorAll(`.opt-btn[data-setting="${key}"]`).forEach(b => {
      b.classList.toggle('active', b.dataset.value === settings[key]);
    });
  });
}

function toggleSettings() {
  const overlay = document.getElementById('settings-overlay');
  overlay.classList.toggle('open');
}

function closeSettingsOnOverlay(e) {
  if (e.target === document.getElementById('settings-overlay')) toggleSettings();
}

// ============================================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ============================================================
const DAY_KEYS = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];

function fmtPts(n) {
  if (n >= 1000000) {
    const v = n / 1000000;
    return (Number.isInteger(v) ? v : v.toFixed(2).replace(/\.?0+$/,'')) + 'M';
  }
  if (n >= 1000) {
    const v = n / 1000;
    return (Number.isInteger(v) ? v : v.toFixed(1).replace(/\.?0+$/,'')) + 'K';
  }
  return n.toString();
}

function getJST() {
  return new Date(new Date().toLocaleString('en-US', {timeZone: 'Asia/Tokyo'}));
}

function getCurrentSlot() {
  const jst = getJST();
  const dayKey = DAY_KEYS[jst.getDay()];
  const h = jst.getHours();
  const slots = DB.schedule[dayKey].slots;
  for (let i = 0; i < slots.length; i++) {
    for (const t of slots[i].times) {
      if (parseInt(t) === h) return { dayKey, slotIdx: i };
    }
  }
  return { dayKey, slotIdx: 0 };
}

// ============================================================
// è¡¨ç¤ºçŠ¶æ…‹
// ============================================================
let viewingDay = null;
let viewingSlot = null;

function goToNow() {
  const cur = getCurrentSlot();
  renderCurrent(cur.dayKey, cur.slotIdx);
  // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ç¾åœ¨ã‚¹ãƒ­ãƒƒãƒˆã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  setTimeout(() => {
    const el = document.querySelector('.slot-row.active');
    if (el) el.scrollIntoView({ block: 'center', behavior: 'smooth' });
  }, 50);
}

// ============================================================
// å·¦ãƒ‘ãƒãƒ«æç”»
// ============================================================
function renderCurrent(dayKey, slotIdx) {
  viewingDay = dayKey;
  viewingSlot = slotIdx;

  const slot = DB.schedule[dayKey].slots[slotIdx];
  const rtype = DB.reward_thresholds.types[slot.reward_type];
  const cur = getCurrentSlot();
  const isNow = (cur.dayKey === dayKey && cur.slotIdx === slotIdx);

  // ãƒªãƒ¯ãƒ¼ãƒ‰ãƒãƒ¼æ›´æ–°
  document.getElementById('rb1').textContent = fmtPts(rtype.reward1);
  document.getElementById('rb2').textContent = fmtPts(rtype.reward2);
  document.getElementById('rb3').textContent = fmtPts(slot.reward3_points);
  document.getElementById('reward-bar-note').textContent = '(' + rtype.label + ')';

  const viewingBadge = isNow ? '' : '<span class="viewing-badge">å‚ç…§ä¸­</span>';
  const noteHtml = slot.note
    ? `<div class="slot-note">â„¹ ${slot.note}</div>` : '';

  let tasksHtml = '';
  slot.tasks.forEach(t => {
    let cls = '';
    if (t.points >= 1000000) cls = 'very-high';
    else if (t.points >= 10000) cls = 'high';
    tasksHtml += `<div class="task-item">
      <span class="task-name">${t.label}</span>
      <span class="task-pts ${cls}">+${fmtPts(t.points)}</span>
    </div>`;
  });

  document.getElementById('current-panel').innerHTML = `
    <div class="current-slot-label">${DB.schedule[dayKey].label} / ã‚¹ãƒ­ãƒƒãƒˆ${slotIdx+1}${viewingBadge}</div>
    <div class="current-event-name">${slot.event}</div>
    <div class="current-time-row">
      ${slot.times.map(t => `<span class="time-chip">${t}</span>`).join('')}
    </div>
    <div class="reward-req">
      <div class="reward-req-item r1">
        <div class="reward-req-label">ãƒªãƒ¯ãƒ¼ãƒ‰ 1</div>
        <div class="reward-req-pts">${fmtPts(rtype.reward1)}</div>
      </div>
      <div class="reward-req-item r2">
        <div class="reward-req-label">ãƒªãƒ¯ãƒ¼ãƒ‰ 2</div>
        <div class="reward-req-pts">${fmtPts(rtype.reward2)}</div>
      </div>
      <div class="reward-req-item r3">
        <div class="reward-req-label">ãƒªãƒ¯ãƒ¼ãƒ‰ 3</div>
        <div class="reward-req-pts">${fmtPts(slot.reward3_points)}</div>
      </div>
    </div>
    ${noteHtml}
    <div class="tasks-title">ã‚¿ã‚¹ã‚¯ä¸€è¦§(${slot.tasks.length}ä»¶)</div>
    ${tasksHtml}
  `;

  // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
  document.querySelectorAll('.slot-row').forEach(el => {
    el.classList.toggle('active',
      el.dataset.day === dayKey && parseInt(el.dataset.slot) === slotIdx);
  });
}

// ============================================================
// å³ãƒ‘ãƒãƒ«æç”»
// ============================================================
function renderSchedule() {
  const panel = document.getElementById('schedule-panel');
  const cur = getCurrentSlot();
  const dayLabels = { sunday:'æ—¥', monday:'æœˆ', tuesday:'ç«', wednesday:'æ°´', thursday:'æœ¨', friday:'é‡‘', saturday:'åœŸ' };

  let html = '<div class="schedule-header">é€±é–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« (ã‚¿ãƒƒãƒ—ã§è©³ç´°è¡¨ç¤º)</div>';

  // æ›œæ—¥ã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³
  html += '<div class="day-jump">';
  for (const dayKey of DAY_KEYS) {
    const isToday = cur.dayKey === dayKey;
    html += `<button class="day-jump-btn ${isToday?'today':''}" onclick="jumpToDay('${dayKey}')">${dayLabels[dayKey]}</button>`;
  }
  html += '</div>';

  for (const dayKey of DAY_KEYS) {
    const day = DB.schedule[dayKey];
    html += `<div class="day-section" id="day-${dayKey}"><div class="day-label">${day.label} ğŸˆ</div>`;
    day.slots.forEach((slot, i) => {
      const isActive = cur.dayKey === dayKey && cur.slotIdx === i;
      html += `<div class="slot-row ${isActive?'active':''}" data-day="${dayKey}" data-slot="${i}"
        onclick="renderCurrent('${dayKey}',${i})">
        <div class="slot-times">${slot.times.join('<br>')}</div>
        <div class="slot-event">${slot.event}</div>
        <div class="slot-r3">${fmtPts(slot.reward3_points)}</div>
      </div>`;
    });
    html += '</div>';
  }
  panel.innerHTML = html;
}

// ============================================================
// æ™‚è¨ˆ
// ============================================================
let lastSlotKey = '';

function updateClock() {
  const jst = getJST();
  const h = String(jst.getHours()).padStart(2,'0');
  const m = String(jst.getMinutes()).padStart(2,'0');
  const s = String(jst.getSeconds()).padStart(2,'0');
  document.getElementById('clock').textContent = `${h}:${m}:${s}`;

  const days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  document.getElementById('clock-date').textContent =
    `${jst.getFullYear()}/${jst.getMonth()+1}/${jst.getDate()}(${days[jst.getDay()]})JST`;

  // ã‚¹ãƒ­ãƒƒãƒˆåˆ‡ã‚Šæ›¿ã‚ã‚Šæ¤œå‡º(æ¯æ™‚5åˆ†)
  const cur = getCurrentSlot();
  const slotKey = `${cur.dayKey}-${cur.slotIdx}`;
  if (slotKey !== lastSlotKey) {
    lastSlotKey = slotKey;
    renderSchedule();
    // ç¾åœ¨ã‚¹ãƒ­ãƒƒãƒˆã‚’è¡¨ç¤ºä¸­ã ã£ãŸå ´åˆã®ã¿è‡ªå‹•æ›´æ–°
    if (viewingDay === null || (viewingDay === cur.dayKey && viewingSlot === cur.slotIdx)) {
      renderCurrent(cur.dayKey, cur.slotIdx);
      setTimeout(() => {
        const el = document.querySelector('.slot-row.active');
        if (el) el.scrollIntoView({ block: 'center', behavior: 'smooth' });
      }, 100);
    }
  }
}

// ============================================================
// åˆæœŸåŒ–
// ============================================================
async function init() {
  // è¨­å®šã®é©ç”¨
  const settings = loadSettings();
  applySettingsToDOM(settings);
  syncSettingButtons(settings);

  // DBèª­ã¿è¾¼ã¿
  const ok = await loadDB();
  if (!ok) return;

  // æç”»
  renderSchedule();
  const cur = getCurrentSlot();
  lastSlotKey = `${cur.dayKey}-${cur.slotIdx}`;
  renderCurrent(cur.dayKey, cur.slotIdx);

  // ç¾åœ¨ã‚¹ãƒ­ãƒƒãƒˆã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  setTimeout(() => {
    const el = document.querySelector('.slot-row.active');
    if (el) el.scrollIntoView({ block: 'center', behavior: 'smooth' });
  }, 300);

  // æ™‚è¨ˆé–‹å§‹
  updateClock();
  setInterval(updateClock, 1000);
}

init();
</script>
</body>
</html>
